<extend name="Public/base" />
<block name="title"><title>BeeCloud微信扫码示例</title></block>
<block name="main">
	<include file="Public/cartcommon" />
	<div class="am-g">
  	
    <div align="center" id="qrcode" >
    </div>
    <div align="center">
        <p>订单号：{$orderNumber}</p>
        <p id="query-result"></p>
    </div>
    <br>
	<input type="hidden" id="codeUrl" value="{$codeUrl}"/>  	
	<input type="hidden" id="orderNumber" value="{$orderNumber}"/>
</div>

</block>
<block name="customizedJavascript">
    <script src="__PUBLIC__/Beecloud/Js/qrcode.js"></script>
    <script>
    $(".cart-step3").addClass("step-on");
    var options = {text: $("#codeUrl").val()};
    //参数1表示图像大小，取值范围1-10；参数2表示质量，取值范围'L','M','Q','H'
    var canvas = BCUtil.createQrCode(options);
    var wording=document.createElement('p');
    wording.innerHTML = "扫描支付订单";
    var element=document.getElementById("qrcode");
    element.appendChild(wording);
    element.appendChild(canvas);
    var orderNumber = $("#orderNumber").val();
    setInterval("synchronous(orderNumber)", 1000); 

function synchronous() {
    var oAjax = new XMLHttpRequest();
    oAjax.open('POST', "__URL__/query", true);
    oAjax.setRequestHeader("Content-Type","application/x-www-form-urlencoded");

    oAjax.onreadystatechange = function () {
        if (oAjax.readyState==4)
        {
            var result = false;
            if (oAjax.status==200)
            {
                result = JSON.parse(oAjax.responseText);

                if (result && result.status == "1") {
                	window.location.href = 'http://payservice.beecloud.cn/spay/result.php';
                    //document.getElementById("query-result").textContent = "支付成功";
                }

            } 
        }

    }
    oAjax.send("orderNumber=" + orderNumber);
} 

    </script>
</block>
